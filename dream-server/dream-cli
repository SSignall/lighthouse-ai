#!/bin/bash
# dream-cli - Command line interface for Dream Server
# Mission: M5 (Clonable Dream Setup Server)
# Version: 1.1.0 — Added mode switch (M1 Phase 3)

set -e

#=============================================================================
# Configuration
#=============================================================================
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_DIR="${DREAM_HOME:-$HOME/dream-server}"
VERSION="1.1.0"
MODE_FILE="${INSTALL_DIR}/.current-mode"
PROFILES_FILE="${INSTALL_DIR}/.profiles"
DEFAULT_MODE="cloud"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

#=============================================================================
# Helpers
#=============================================================================
log() { echo -e "${CYAN}[dream]${NC} $1"; }
success() { echo -e "${GREEN}✓${NC} $1"; }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1"; exit 1; }

# B6 fix: Safe .env loading (prevents shell injection)
load_env() {
    [[ -f "$INSTALL_DIR/.env" ]] || return 0
    set -a
    while IFS='=' read -r key value; do
        # Skip comments and empty lines
        [[ "$key" =~ ^[[:space:]]*# ]] && continue
        [[ -z "$key" ]] && continue
        # Only allow alphanumeric + underscore in key names
        [[ "$key" =~ ^[A-Za-z_][A-Za-z0-9_]*$ ]] || continue
        # Strip quotes from value
        value="${value%\"}"
        value="${value#\"}"
        value="${value%\'}"
        value="${value#\'}"
        export "$key=$value"
    done < "$INSTALL_DIR/.env"
    set +a
}

check_install() {
    if [[ ! -d "$INSTALL_DIR" ]]; then
        error "Dream Server not found at $INSTALL_DIR. Set DREAM_HOME or run installer first."
    fi
    if [[ ! -f "$INSTALL_DIR/docker-compose.yml" ]]; then
        error "docker-compose.yml not found in $INSTALL_DIR"
    fi
}

#=============================================================================
# Commands
#=============================================================================

cmd_status() {
    check_install
    cd "$INSTALL_DIR"
    
    echo -e "${BLUE}━━━ Dream Server Status ━━━${NC}"
    echo ""
    
    # Container status
    docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || docker-compose ps
    
    echo ""
    
    # Health checks
    echo -e "${BLUE}━━━ Health Checks ━━━${NC}"
    
    check_endpoint() {
        local name=$1
        local url=$2
        if curl -sf "$url" > /dev/null 2>&1; then
            success "$name: healthy"
        else
            warn "$name: not responding"
        fi
    }
    
    # Read ports from .env or use defaults (B6 fix: safe env loading)
    load_env
    
    check_endpoint "vLLM" "http://localhost:${VLLM_PORT:-8000}/health"
    check_endpoint "Open WebUI" "http://localhost:${WEBUI_PORT:-3000}"
    
    # Optional services
    docker compose ps --format "{{.Name}}" 2>/dev/null | grep -q whisper && \
        check_endpoint "Whisper" "http://localhost:${WHISPER_PORT:-9000}"
    docker compose ps --format "{{.Name}}" 2>/dev/null | grep -q n8n && \
        check_endpoint "n8n" "http://localhost:${N8N_PORT:-5678}"
    docker compose ps --format "{{.Name}}" 2>/dev/null | grep -q qdrant && \
        check_endpoint "Qdrant" "http://localhost:${QDRANT_PORT:-6333}"
    
    echo ""
    
    # GPU status if available
    if command -v nvidia-smi &> /dev/null; then
        echo -e "${BLUE}━━━ GPU Status ━━━${NC}"
        nvidia-smi --query-gpu=name,utilization.gpu,memory.used,memory.total,temperature.gpu --format=csv,noheader,nounits | \
            awk -F', ' '{printf "  %s: %s%% GPU | %sMB/%sMB VRAM | %s°C\n", $1, $2, $3, $4, $5}'
    fi
}

cmd_logs() {
    check_install
    cd "$INSTALL_DIR"
    
    local service="${1:-}"
    local lines="${2:-100}"
    
    if [[ -z "$service" ]]; then
        log "Usage: dream logs <service> [lines]"
        log "Services: vllm, open-webui, whisper, tts, n8n, qdrant, embeddings"
        exit 1
    fi
    
    # Map friendly names to container names
    case "$service" in
        vllm|llm) service="vllm" ;;
        webui|ui|web) service="open-webui" ;;
        whisper|stt) service="whisper" ;;
        tts|kokoro) service="tts" ;;
        n8n|workflows) service="n8n" ;;
        qdrant|vector) service="qdrant" ;;
        embeddings|embed) service="embeddings" ;;
        livekit) service="livekit" ;;
        voice-agent) service="livekit-voice-agent" ;;
        openclaw) service="openclaw" ;;
        dashboard) service="dashboard" ;;
        dashboard-api) service="dashboard-api" ;;
        privacy-shield) service="privacy-shield" ;;
        token-spy) service="token-spy" ;;
        litellm) service="litellm" ;;
    esac
    
    docker compose logs -f --tail "$lines" "$service"
}

cmd_restart() {
    check_install
    cd "$INSTALL_DIR"
    
    local service="${1:-}"
    
    if [[ -z "$service" ]]; then
        log "Restarting all services..."
        docker compose restart
        success "All services restarted"
    else
        # A8 fix: Map friendly names to compose service names (not container names)
        case "$service" in
            vllm|llm) service="vllm" ;;
            webui|ui|web) service="open-webui" ;;
            whisper|stt) service="whisper" ;;
            tts|kokoro) service="tts" ;;
            n8n|workflows) service="n8n" ;;
            qdrant|vector) service="qdrant" ;;
            embeddings|embed) service="embeddings" ;;
            livekit) service="livekit" ;;
            voice-agent) service="livekit-voice-agent" ;;
            openclaw) service="openclaw" ;;
            dashboard) service="dashboard" ;;
            dashboard-api) service="dashboard-api" ;;
            privacy-shield) service="privacy-shield" ;;
            token-spy) service="token-spy" ;;
            token-spy-db) service="token-spy-db" ;;
            token-spy-redis) service="token-spy-redis" ;;
            litellm) service="litellm" ;;
        esac

        log "Restarting $service..."
        docker compose restart "$service"
        success "$service restarted"
    fi
}

cmd_stop() {
    check_install
    cd "$INSTALL_DIR"
    
    local service="${1:-}"
    
    if [[ -z "$service" ]]; then
        log "Stopping all services..."
        docker compose down
        success "All services stopped"
    else
        # A8 fix: Map friendly names to compose service names (not container names)
        case "$service" in
            vllm|llm) service="vllm" ;;
            webui|ui|web) service="open-webui" ;;
            whisper|stt) service="whisper" ;;
            tts|kokoro) service="tts" ;;
            n8n|workflows) service="n8n" ;;
            qdrant|vector) service="qdrant" ;;
            embeddings|embed) service="embeddings" ;;
            livekit) service="livekit" ;;
            voice-agent) service="livekit-voice-agent" ;;
            openclaw) service="openclaw" ;;
            dashboard) service="dashboard" ;;
            dashboard-api) service="dashboard-api" ;;
            privacy-shield) service="privacy-shield" ;;
            token-spy) service="token-spy" ;;
            litellm) service="litellm" ;;
        esac

        log "Stopping $service..."
        docker compose stop "$service"
        success "$service stopped"
    fi
}

cmd_start() {
    check_install
    cd "$INSTALL_DIR"
    
    local service="${1:-}"
    
    if [[ -z "$service" ]]; then
        log "Starting all services..."
        docker compose up -d
        success "All services started"
    else
        # A8 fix: Map friendly names to compose service names (not container names)
        case "$service" in
            vllm|llm) service="vllm" ;;
            webui|ui|web) service="open-webui" ;;
            whisper|stt) service="whisper" ;;
            tts|kokoro) service="tts" ;;
            n8n|workflows) service="n8n" ;;
            qdrant|vector) service="qdrant" ;;
            embeddings|embed) service="embeddings" ;;
            livekit) service="livekit" ;;
            voice-agent) service="livekit-voice-agent" ;;
            openclaw) service="openclaw" ;;
            dashboard) service="dashboard" ;;
            dashboard-api) service="dashboard-api" ;;
            privacy-shield) service="privacy-shield" ;;
            token-spy) service="token-spy" ;;
            litellm) service="litellm" ;;
        esac

        log "Starting $service..."
        docker compose up -d "$service"
        success "$service started"
    fi
}

cmd_update() {
    check_install
    cd "$INSTALL_DIR"
    
    local compose_file=$(get_compose_file)
    
    log "Pulling latest images..."
    docker compose -f "$compose_file" pull
    
    log "Recreating containers with new images..."
    docker compose -f "$compose_file" up -d --force-recreate
    
    success "Update complete"
    
    log "Checking health..."
    sleep 5
    cmd_status
}

cmd_shell() {
    check_install
    cd "$INSTALL_DIR"
    
    local service="${1:-vllm}"
    
    # Map friendly names to container names
    case "$service" in
        vllm|llm) service="dream-vllm" ;;
        webui|ui|web) service="dream-webui" ;;
        whisper|stt) service="dream-whisper" ;;
        tts|kokoro) service="dream-tts" ;;
        n8n|workflows) service="dream-n8n" ;;
        qdrant|vector) service="dream-qdrant" ;;
        embeddings|embed) service="dream-embeddings" ;;
        livekit) service="dream-livekit" ;;
        voice-agent) service="dream-voice-agent" ;;
        openclaw) service="dream-openclaw" ;;
        dashboard) service="dream-dashboard" ;;
        dashboard-api) service="dream-dashboard-api" ;;
        privacy-shield) service="dream-privacy-shield" ;;
        token-spy) service="dream-token-spy" ;;
        litellm) service="dream-litellm" ;;
    esac
    
    log "Opening shell in $service..."
    docker exec -it "$service" /bin/bash || docker exec -it "$service" /bin/sh
}

cmd_config() {
    check_install
    
    local action="${1:-show}"
    
    case "$action" in
        show)
            echo -e "${BLUE}━━━ Configuration ━━━${NC}"
            echo "Install dir: $INSTALL_DIR"
            echo ""
            echo -e "${CYAN}.env contents:${NC}"
            grep -v "^#" "$INSTALL_DIR/.env" | grep -v "^$" | while read line; do
                # Hide sensitive values
                if echo "$line" | grep -qiE "(secret|pass|token|key)="; then
                    echo "  ${line%%=*}=***"
                else
                    echo "  $line"
                fi
            done
            ;;
        edit)
            ${EDITOR:-nano} "$INSTALL_DIR/.env"
            warn "Restart services for changes to take effect: dream restart"
            ;;
        *)
            log "Usage: dream config [show|edit]"
            ;;
    esac
}

cmd_chat() {
    check_install
    load_env  # B6 fix: use safe env loading function
    
    local message="${1:-Hello}"
    local model="${2:-}"
    
    # Get model from vLLM if not specified
    if [[ -z "$model" ]]; then
        model=$(curl -s "http://localhost:${VLLM_PORT:-8000}/v1/models" | grep -oP '"id":\s*"\K[^"]+' | head -1)
    fi
    
    log "Sending to $model..."
    
    # Use jq to safely construct JSON payload (prevents injection)
    local payload=$(jq -n --arg model "$model" --arg msg "$message" \
        '{model: $model, messages: [{role: "user", content: $msg}], max_tokens: 500}')
    
    curl -s "http://localhost:${VLLM_PORT:-8000}/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -d "$payload" | jq -r '.choices[0].message.content // .error.message // "Error: no response"'
}

cmd_benchmark() {
    check_install
    load_env  # B6 fix: use safe env loading function
    
    log "Running quick benchmark..."
    
    local start=$(date +%s%N)
    local response=$(cmd_chat "Say exactly: Hello World" 2>/dev/null)
    local end=$(date +%s%N)
    
    local duration=$(( (end - start) / 1000000 ))
    
    echo ""
    echo -e "${BLUE}━━━ Benchmark Results ━━━${NC}"
    echo "  Response time: ${duration}ms"
    echo "  Response: $response"
    
    if [[ $duration -lt 2000 ]]; then
        success "Performance: Excellent (<2s)"
    elif [[ $duration -lt 5000 ]]; then
        success "Performance: Good (<5s)"
    else
        warn "Performance: Slow (>5s) - check GPU/model"
    fi
}

#=============================================================================
# Mode Switch Commands (M1 Zero-Cloud Phase 3)
#=============================================================================
get_current_mode() {
    if [[ -f "$MODE_FILE" ]]; then
        cat "$MODE_FILE"
    else
        echo "$DEFAULT_MODE"
    fi
}

save_mode() {
    echo "$1" > "$MODE_FILE"
}

save_profiles() {
    echo "$1" > "$PROFILES_FILE"
}

get_profiles() {
    if [[ -f "$PROFILES_FILE" ]]; then
        cat "$PROFILES_FILE"
    fi
}

get_compose_file() {
    local mode=$(get_current_mode)
    echo "${INSTALL_DIR}/docker-compose.${mode}.yml"
}

cmd_mode() {
    check_install
    
    local action="${1:-status}"
    shift || true  # Remove action from args, leave remaining as profile flags
    
    case "$action" in
        status|s)
            local current=$(get_current_mode)
            local profiles=$(get_profiles)
            echo -e "${BLUE}━━━ Dream Server Mode ━━━${NC}"
            echo ""
            echo -e "Current mode: ${GREEN}${current}${NC}"
            if [[ -n "$profiles" ]]; then
                echo -e "Profiles: ${CYAN}${profiles}${NC}"
            fi
            echo ""
            
            case "$current" in
                cloud)
                    echo "  Mode: Full cloud model access"
                    echo "  LLM:  LiteLLM → Cloud APIs (Claude, GPT-4, etc.)"
                    echo "  Cost: ~\$0.003-0.06/1K tokens"
                    ;;
                local)
                    echo "  Mode: 100% offline operation"
                    echo "  LLM:  Local vLLM (Qwen 32B)"
                    echo "  Cost: \$0 (electricity only)"
                    ;;
                hybrid)
                    echo "  Mode: Local-first with cloud fallback"
                    echo "  LLM:  Local vLLM → Cloud fallback on failure"
                    echo "  Cost: \$0 when local works, cloud rates on fallback"
                    ;;
            esac
            
            echo ""
            echo -e "${CYAN}Available modes:${NC}"
            echo "  dream mode cloud   - Full cloud model access"
            echo "  dream mode local   - 100% offline, local GPU"
            echo "  dream mode hybrid  - Local-first + cloud fallback"
            echo ""
            echo -e "${CYAN}Profile flags:${NC}"
            echo "  --profile voice       - Include voice agent services"
            echo "  --profile openclaw    - Include OpenClaw agent services"
            echo "  --profile monitoring  - Include Prometheus/Grafana"
            echo "  --profile privacy     - Include privacy shield"
            echo "  --profile workflows   - Include n8n workflows"
            echo ""
            echo "  Example: dream mode local --profile voice --profile monitoring"
            ;;
            
        cloud|local|hybrid)
            local new_mode="$action"
            local current=$(get_current_mode)
            local compose_file="${INSTALL_DIR}/docker-compose.${new_mode}.yml"
            
            # Check compose file exists
            if [[ ! -f "$compose_file" ]]; then
                error "Compose file not found: docker-compose.${new_mode}.yml"
            fi
            
            # A10 fix: Capture profile flags from command line
            local profile_flags="$*"
            
            echo -e "${BLUE}━━━ Switching Dream Server Mode ━━━${NC}"
            echo ""
            echo -e "  From: ${YELLOW}${current}${NC}"
            echo -e "  To:   ${GREEN}${new_mode}${NC}"
            if [[ -n "$profile_flags" ]]; then
                echo -e "  Profiles: ${CYAN}${profile_flags}${NC}"
            fi
            echo ""
            
            # Mode-specific warnings
            case "$new_mode" in
                local)
                    warn "Local mode requires pre-downloaded models in ./models/"
                    warn "Web search will be disabled (requires internet)"
                    ;;
                cloud)
                    warn "Cloud mode requires valid API keys in .env"
                    warn "All LLM requests will go to cloud providers"
                    ;;
                hybrid)
                    warn "Hybrid mode uses local first, cloud as fallback"
                    warn "API keys optional but recommended for reliability"
                    ;;
            esac
            
            echo ""
            read -p "Continue? [y/N] " -n 1 -r
            echo ""
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                log "Cancelled"
                exit 0
            fi
            
            cd "$INSTALL_DIR"
            
            # Stop current services
            log "Stopping current services..."
            local current_compose="${INSTALL_DIR}/docker-compose.${current}.yml"
            if [[ -f "$current_compose" ]]; then
                docker compose -f "$current_compose" down 2>/dev/null || \
                    docker-compose -f "$current_compose" down 2>/dev/null || true
            fi
            
            # A10 fix: Save profile flags if provided, otherwise keep existing
            if [[ -n "$profile_flags" ]]; then
                save_profiles "$profile_flags"
            else
                # Load saved profiles if none specified
                profile_flags=$(get_profiles)
            fi
            
            # Save new mode
            save_mode "$new_mode"
            
            # Start new services with profiles
            log "Starting ${new_mode} mode services..."
            if [[ -n "$profile_flags" ]]; then
                docker compose -f "$compose_file" $profile_flags up -d 2>/dev/null || \
                    docker-compose -f "$compose_file" $profile_flags up -d
            else
                docker compose -f "$compose_file" up -d 2>/dev/null || \
                    docker-compose -f "$compose_file" up -d
            fi
            
            echo ""
            success "Mode switched to: ${new_mode}"
            
            # Wait and show status
            log "Waiting for services to start..."
            sleep 5
            
            echo ""
            docker compose -f "$compose_file" ps --format "table {{.Name}}\t{{.Status}}" 2>/dev/null || \
                docker-compose -f "$compose_file" ps
            ;;
            
        *)
            error "Unknown mode action: $action. Use: status, cloud, local, or hybrid"
            ;;
    esac
}

cmd_help() {
    cat << EOF
${BLUE}Dream Server CLI v${VERSION}${NC}

Usage: dream <command> [options]

${CYAN}Commands:${NC}
  status              Show service health and GPU status
  mode [cloud|local|hybrid|status]
                      Switch between cloud/local/hybrid modes
  logs <service>      Tail logs for a service
  restart [service]   Restart services (all if no service specified)
  start [service]     Start services
  stop [service]      Stop services
  update              Pull latest images and restart
  shell <service>     Open shell in container
  config [show|edit]  View or edit configuration
  chat "<message>"    Quick chat with the LLM
  benchmark           Run a quick performance test
  help                Show this help

${CYAN}Mode Commands (M1 Zero-Cloud):${NC}
  mode status         Show current mode
  mode cloud          Switch to cloud mode (full API access)
  mode local          Switch to local mode (100% offline)
  mode hybrid         Switch to hybrid mode (local-first + cloud fallback)

${CYAN}Service aliases:${NC}
  vllm, llm           LLM inference server
  webui, ui, web      Open WebUI chat interface
  whisper, stt        Speech-to-text
  tts, kokoro         Text-to-speech (Kokoro)
  n8n, workflows      Workflow automation
  qdrant, vector      Vector database

${CYAN}Examples:${NC}
  dream status                    # Check all services
  dream mode local                # Switch to local mode
  dream mode status               # Show current mode
  dream logs vllm                 # Watch vLLM logs
  dream restart whisper           # Restart just Whisper
  dream chat "What is 2+2?"       # Quick LLM test
  dream config edit               # Edit .env file

${CYAN}Environment:${NC}
  DREAM_HOME          Installation directory (default: ~/dream-server)

EOF
}

#=============================================================================
# Main
#=============================================================================
case "${1:-help}" in
    status|s)    cmd_status ;;
    mode|m)      shift; cmd_mode "$@" ;;
    logs|log|l)  shift; cmd_logs "$@" ;;
    restart|r)   shift; cmd_restart "$@" ;;
    start)       shift; cmd_start "$@" ;;
    stop)        shift; cmd_stop "$@" ;;
    update|u)    cmd_update ;;
    shell|sh)    shift; cmd_shell "$@" ;;
    config|cfg)  shift; cmd_config "$@" ;;
    chat|c)      shift; cmd_chat "$@" ;;
    benchmark|bench|b) cmd_benchmark ;;
    help|h|--help|-h) cmd_help ;;
    version|v|--version|-v) echo "dream-cli v${VERSION}" ;;
    *)           error "Unknown command: $1. Run 'dream help' for usage." ;;
esac
