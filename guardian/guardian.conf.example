# ============================================================================
# Guardian — Desired State Configuration
# ============================================================================
# This file defines what "healthy" looks like. Guardian checks every cycle
# and auto-heals anything that deviates. Agents cannot modify this file
# (owned by root, run as system service).
#
# Format: INI-style sections. Each section is a protected resource.
#
# Organize sections by dependency criticality:
#
#   TIER 1 — AGENT LIFELINE (agent is dead without these)
#   TIER 2 — API ROUTING (agent can't think without these)
#   TIER 3 — MEMORY & CONTEXT (agent loses memory without these)
#   TIER 4 — HELPERS (degraded but alive without these)
#
# See docs/HEALTH-CHECKS.md for the full reference.
#
# IMPORTANT: All example sections ship as enabled=false. Enable only
# the sections you've configured for your infrastructure.
# ============================================================================

[general]
check_interval=60
log_file=/var/log/guardian.log
max_log_size=10485760
backup_dir=/var/lib/guardian/backups
backup_generations=5

# ============================================================================
# TIER 1 — AGENT LIFELINE
# ============================================================================

# Example: systemd user service (e.g. an OpenClaw gateway)
[my-gateway]
enabled=false
type=systemd-user
description=My OpenClaw Gateway
service=openclaw-gateway.service
systemd_user=deploy
required_ports=3100
health_port=3100
protected_files=/home/deploy/.openclaw/openclaw.json,/home/deploy/.openclaw/agents/main/agent/models.json
protected_service=/home/deploy/.config/systemd/user/openclaw-gateway.service
max_soft_restarts=3
restart_grace=15
skip_immutable=true

# ============================================================================
# TIER 2 — API ROUTING
# ============================================================================

# Example: standalone process (matched by pgrep, started via start_cmd)
[my-api-server]
enabled=false
type=process
description=API Server
process_match=uvicorn main:app.*8080
required_ports=8080
health_url=http://127.0.0.1:8080/health
start_cmd=start.sh
start_dir=/opt/myapp
start_user=deploy
start_venv=/opt/myapp/venv
protected_files=/opt/myapp/main.py,/opt/myapp/start.sh
max_soft_restarts=3
restart_grace=10

# ============================================================================
# TIER 3 — MEMORY & CONTEXT
# ============================================================================

# Example: docker container
[my-database]
enabled=false
type=docker
description=Vector Database
container_name=qdrant-prod
required_ports=6333
health_url=http://127.0.0.1:6333/healthz
max_soft_restarts=3
restart_grace=15

# Example: file integrity with JSON validation
[my-settings]
enabled=false
type=file-integrity
description=Application Settings (must be valid JSON)
protected_files=/opt/myapp/data/settings.json
required_json_keys=session_limit,poll_interval,agents
# Pin specific JSON values (dot-notation path=expected_value)
# required_json_values=agents.defaults.model.primary=gpt-4
max_soft_restarts=1
restart_grace=5

# ============================================================================
# TIER 4 — HELPERS
# ============================================================================

# Example: process with restart delegation
# When ollama dies, restart the gateway (which will respawn ollama)
[ollama]
enabled=false
type=process
description=Ollama Local LLM Server
process_match=ollama serve
required_ports=11434
health_url=http://127.0.0.1:11434/api/tags
max_soft_restarts=2
restart_grace=15
restart_via=my-gateway

# Example: file integrity for scripts (no JSON validation)
[my-scripts]
enabled=false
type=file-integrity
description=Operational Scripts
protected_files=/opt/myapp/backup.sh,/opt/myapp/monitor.py
max_soft_restarts=0
restart_grace=10
skip_immutable=true

# Example: custom health command
# health_cmd runs in bash; non-zero exit = unhealthy
[my-custom-check]
enabled=false
type=process
description=Service with custom health check
process_match=myservice
health_cmd=/opt/myapp/health-check.sh
start_cmd=myservice.sh
start_dir=/opt/myapp
start_user=deploy
max_soft_restarts=3
restart_grace=10
